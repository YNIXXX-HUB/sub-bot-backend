<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Growth</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #09090b; --panel: #18181b; --border: #27272a; --accent: #6366f1; --text: #fff; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; margin: 0; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        /* MODAL & AUTH */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 50; display: flex; align-items: center; justify-content: center; }
        .box { background: var(--panel); padding: 30px; border: 1px solid var(--border); border-radius: 12px; width: 400px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #27272a; border: 1px solid #3f3f46; color: white; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        textarea { width: 100%; height: 150px; background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 0.8rem; margin-top: 10px; border: 1px solid #333; }
        
        /* APP LAYOUT */
        #app { display: none; height: 100vh; display: flex; }
        aside { width: 250px; padding: 20px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        main { flex: 1; padding: 20px; overflow-y: auto; }
        .chat-section { width: 300px; background: var(--panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        
        .card { background: var(--panel); padding: 15px; border: 1px solid var(--border); margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 15px; }
        .chat-input { padding: 15px; border-top: 1px solid var(--border); }
        .menu-btn { padding: 10px; cursor: pointer; color: #a1a1aa; margin-bottom: 5px; }
        .menu-btn:hover { color: white; background: #27272a; border-radius: 6px; }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-overlay" class="overlay">
        <div class="box">
            <h1 style="color:var(--accent)">Nexus ðŸš€</h1>
            <p id="error-msg" style="color:#ef4444; font-size:0.9rem;"></p>
            
            <div id="l-form">
                <input id="l-user" placeholder="Username">
                <input id="l-pass" type="password" placeholder="Password">
                <button onclick="login()">Log In</button>
                <p style="margin-top:10px; font-size:0.9rem; cursor:pointer;" onclick="toggleAuth()">Create Account</p>
            </div>
            
            <div id="s-form" class="hidden">
                <input id="s-user" placeholder="New Username">
                <input id="s-pass" type="password" placeholder="New Password">
                <button onclick="signup()">Sign Up</button>
                <p style="margin-top:10px; font-size:0.9rem; cursor:pointer;" onclick="toggleAuth()">Back to Login</p>
            </div>
        </div>
    </div>

    <!-- SCRIPT DOWNLOAD POPUP -->
    <div id="script-modal" class="overlay hidden">
        <div class="box" style="width: 500px; text-align: left;">
            <h3>ðŸ“œ Install the Script</h3>
            <p style="font-size:0.9rem; color:#aaa;">1. Install <b>Tampermonkey</b> extension.<br>2. Create New Script.<br>3. Paste this code & Save.</p>
            <textarea id="script-code" readonly></textarea>
            <button onclick="copyScript()">Copy Code</button>
            <button onclick="document.getElementById('script-modal').classList.add('hidden')" style="background:#333;">Close</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app">
        <aside>
            <h2 style="color:var(--accent)">Nexus</h2>
            <div style="background:#27272a; padding:15px; border-radius:8px; margin: 20px 0;">
                <h3 id="d-user">User</h3>
                <p>Points: <span id="d-pts" style="color:var(--accent)">0</span></p>
            </div>
            
            <div class="menu-btn" onclick="showScriptModal()">ðŸ“œ Get Script</div>
            <div style="flex:1"></div>
            <div class="menu-btn" style="color:#ef4444" onclick="logout()">Log Out</div>
        </aside>

        <main>
            <div style="background:#27272a; padding:20px; border-radius:8px; margin-bottom:20px;">
                <h3>Promote Channel (-50 pts)</h3>
                <div style="display:flex; gap:10px;">
                    <input id="promo-url" placeholder="https://youtube.com/..." style="margin:0;">
                    <button onclick="promote()" style="width:auto; margin:0;">Promote</button>
                </div>
            </div>
            <h3>Active Promotions</h3>
            <div id="feed">Loading...</div>
        </main>

        <div class="chat-section">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold;">Live Chat</div>
            <div class="chat-msgs" id="chat-box"></div>
            <div class="chat-input">
                <input id="chat-msg" placeholder="Type..." onkeypress="if(event.key==='Enter') sendChat()">
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentUser = null;
        const RENDER_URL = window.location.origin; // Automatically gets your website URL

        // --- AUTO LOGIN LOGIC ---
        window.onload = function() {
            const savedUser = localStorage.getItem('nexus_user');
            if(savedUser) {
                // Auto-login (we trust local storage for UI, real validation happens on server actions)
                currentUser = savedUser;
                enterApp(); 
            }
        }

        function toggleAuth() { 
            document.getElementById('l-form').classList.toggle('hidden');
            document.getElementById('s-form').classList.toggle('hidden');
        }

        async function login() {
            const u = document.getElementById('l-user').value;
            const p = document.getElementById('l-pass').value;
            try {
                const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) });
                const data = await res.json();
                if(data.success) {
                    currentUser = data.username;
                    localStorage.setItem('nexus_user', currentUser); // SAVE SESSION
                    enterApp();
                } else document.getElementById('error-msg').innerText = data.error;
            } catch(e) { document.getElementById('error-msg').innerText = "Connection Failed"; }
        }

        async function signup() {
            const u = document.getElementById('s-user').value;
            const p = document.getElementById('s-pass').value;
            try {
                const res = await fetch('/api/signup', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) });
                const data = await res.json();
                if(data.success) { alert("Created! Login now."); toggleAuth(); }
                else document.getElementById('error-msg').innerText = data.error;
            } catch(e) { document.getElementById('error-msg').innerText = "Connection Failed"; }
        }

        function logout() {
            localStorage.removeItem('nexus_user');
            location.reload();
        }

        function enterApp() {
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('app').style.display = 'flex';
            document.getElementById('d-user').innerText = currentUser;
            loadFeed();
        }

        // --- SCRIPT MODAL ---
        function showScriptModal() {
            const code = `// ==UserScript==\n// @name Nexus Helper\n// @match https://www.youtube.com/*\n// ==/UserScript==\n(function(){\n 'use strict';\n const BACKEND="${RENDER_URL}";\n let user=prompt("Enter Nexus Username:");\n if(!user) return;\n document.addEventListener('click',e=>{\n  if(e.target.innerText.includes("Subscribe")){\n   setTimeout(()=>{\n    fetch(BACKEND+"/verify_action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:user,type:"SUB"})});\n   },2000);\n  }\n });\n})();`;
            document.getElementById('script-code').value = code;
            document.getElementById('script-modal').classList.remove('hidden');
        }

        function copyScript() {
            const copyText = document.getElementById("script-code");
            copyText.select();
            document.execCommand("copy");
            alert("Copied! Paste into Tampermonkey.");
        }

        // --- APP LOGIC ---
        async function promote() {
            const url = document.getElementById('promo-url').value;
            const res = await fetch('/api/promote', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: currentUser, url: url, type: 'channel'}) });
            const data = await res.json();
            if(data.success) alert("Promoted!"); else alert(data.error);
        }

        async function loadFeed() {
            const res = await fetch('/api/data', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: currentUser}) });
            const data = await res.json();
            document.getElementById('d-pts').innerText = data.points; // Update points
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            data.links.forEach(l => {
                feed.innerHTML += `<div class="card"><div><b>${l.owner}</b></div><a href="${l.url}" target="_blank"><button style="margin:0; padding:5px 15px; width:auto;">Visit</button></a></div>`;
            });
        }

        function sendChat() {
            const msg = document.getElementById('chat-msg').value;
            socket.emit('send_message', {username: currentUser, message: msg});
            document.getElementById('chat-msg').value = '';
        }
        socket.on('receive_message', (d) => {
            const box = document.getElementById('chat-box');
            box.innerHTML += `<div style="margin-bottom:5px;"><b>${d.username}:</b> ${d.message}</div>`;
            box.scrollTop = box.scrollHeight;
        });
        socket.on('new_promotion', () => loadFeed());
        socket.on('update_stats', (d) => { if(d.username === currentUser) document.getElementById('d-pts').innerText = parseInt(document.getElementById('d-pts').innerText) + d.points; });
    </script>
</body>
</html>
